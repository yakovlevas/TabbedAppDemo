<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:TabbedAppDemo.Converters"
             x:Class="TabbedAppDemo.Views.Tab2Page"
             Title="Ð¡Ð´ÐµÐ»ÐºÐ¸">

    <ContentPage.Resources>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,Auto,*,Auto" 
          Padding="10"
          BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}">

        <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº -->
        <Label 
            Text="{Binding Title}"
            FontSize="24"
            FontAttributes="Bold"
            HorizontalOptions="Center"
            Margin="0,10"
            TextColor="{AppThemeBinding Light=Black, Dark=White}"
            Grid.Row="0" />

        <!-- ÐŸÐµÑ€Ð¸Ð¾Ð´ Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð²Ñ‹Ð±Ð¾Ñ€Ð° -->
        <Frame Grid.Row="1"
               Margin="0,0,0,10"
               Padding="15"
               CornerRadius="10"
               BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2C2C2C}"
               BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}">

            <VerticalStackLayout Spacing="10">
                <!-- ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð° -->
                <Grid ColumnDefinitions="*,Auto,*" ColumnSpacing="10">
                    <!-- Ð”Ð°Ñ‚Ð° Ð½Ð°Ñ‡Ð°Ð»Ð° -->
                    <DatePicker Date="{Binding StartDate}"
                                Format="dd.MM.yyyy"
                                FontSize="14"
                                TextColor="{AppThemeBinding Light=Black, Dark=White}"
                                HorizontalOptions="FillAndExpand"
                                Grid.Column="0"/>

                    <Label Text="-"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=Black, Dark=White}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           Grid.Column="1"/>

                    <!-- Ð”Ð°Ñ‚Ð° Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ -->
                    <DatePicker Date="{Binding EndDate}"
                                Format="dd.MM.yyyy"
                                FontSize="14"
                                TextColor="{AppThemeBinding Light=Black, Dark=White}"
                                HorizontalOptions="FillAndExpand"
                                Grid.Column="2"/>
                </Grid>

                <!-- Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð° -->
                <HorizontalStackLayout Spacing="5" HorizontalOptions="Center">
                    <Button Text="ÐÐµÐ´ÐµÐ»Ñ"
                            Command="{Binding SetDateRangeCommand}"
                            CommandParameter="week"
                            Padding="12,6"
                            CornerRadius="8"
                            BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}"
                            TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}"
                            FontSize="12"/>

                    <Button Text="ÐœÐµÑÑÑ†"
                            Command="{Binding SetDateRangeCommand}"
                            CommandParameter="month"
                            Padding="12,6"
                            CornerRadius="8"
                            BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}"
                            TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}"
                            FontSize="12"/>

                    <Button Text="ÐšÐ²Ð°Ñ€Ñ‚Ð°Ð»"
                            Command="{Binding SetDateRangeCommand}"
                            CommandParameter="quarter"
                            Padding="12,6"
                            CornerRadius="8"
                            BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}"
                            TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}"
                            FontSize="12"/>

                    <Button Text="Ð“Ð¾Ð´"
                            Command="{Binding SetDateRangeCommand}"
                            CommandParameter="year"
                            Padding="12,6"
                            CornerRadius="8"
                            BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}"
                            TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}"
                            FontSize="12"/>
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Frame>

        <!-- Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ -->
        <Grid Grid.Row="2"
              ColumnDefinitions="*,*"
              ColumnSpacing="10"
              Margin="0,0,0,15">

            <!-- Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° -->
            <Frame Grid.Column="0"
                   Padding="15"
                   CornerRadius="10"
                   BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2C2C2C}"
                   BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}">

                <VerticalStackLayout Spacing="5">
                    <Label Text="Ð˜Ñ‚Ð¾Ð³ Ð·Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           HorizontalOptions="Center"/>

                    <Label Text="{Binding NetResultText}"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="{Binding NetResultColor}"
                           HorizontalOptions="Center"/>

                    <Label Text="{Binding TotalVolumeText}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ -->
            <Frame Grid.Column="1"
                   Padding="15"
                   CornerRadius="10"
                   BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2C2C2C}"
                   BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}">

                <HorizontalStackLayout Spacing="5" HorizontalOptions="Center">
                    <Button Text="Ð’ÑÐµ"
                            Command="{Binding ApplyFilterCommand}"
                            Padding="8,4"
                            CornerRadius="6"
                            BackgroundColor="{AppThemeBinding Light=#E8F5E8, Dark=#1B5E20}"
                            TextColor="{AppThemeBinding Light=#2E7D32, Dark=#A5D6A7}"
                            FontSize="10"/>

                    <Button Text="ðŸ“ˆ"
                            Command="{Binding ApplyFilterCommand}"
                            CommandParameter="buy"
                            Padding="8,4"
                            CornerRadius="6"
                            BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#B71C1C}"
                            TextColor="{AppThemeBinding Light=#C62828, Dark=#EF9A9A}"
                            FontSize="10"/>

                    <Button Text="ðŸ“‰"
                            Command="{Binding ApplyFilterCommand}"
                            CommandParameter="sell"
                            Padding="8,4"
                            CornerRadius="6"
                            BackgroundColor="{AppThemeBinding Light=#E8F5E8, Dark=#1B5E20}"
                            TextColor="{AppThemeBinding Light=#2E7D32, Dark=#A5D6A7}"
                            FontSize="10"/>

                    <Button Text="ðŸ’°"
                            Command="{Binding ApplyFilterCommand}"
                            CommandParameter="income"
                            Padding="8,4"
                            CornerRadius="6"
                            BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}"
                            TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}"
                            FontSize="10"/>
                </HorizontalStackLayout>
            </Frame>
        </Grid>

        <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐ´ÐµÐ»Ð¾Ðº -->
        <RefreshView Grid.Row="3"
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding RefreshDataCommand}"
                     IsEnabled="{Binding IsConnected}">

            <CollectionView ItemsSource="{Binding GroupedOperations}"
                            SelectionMode="None">

                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center"
                                         VerticalOptions="Center"
                                         Spacing="20"
                                         Padding="40">
                        <Label Text="ðŸ“­"
                               FontSize="48"
                               HorizontalOptions="Center"/>

                        <Label Text="Ð¡Ð´ÐµÐ»Ð¾Ðº Ð½ÐµÑ‚"
                               FontSize="18"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               TextColor="{AppThemeBinding Light=Black, Dark=White}"/>

                        <Label Text="ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÑÑŒ Ðº Tinkoff API Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿ÐµÑ€Ð¸Ð¾Ð´"
                               FontSize="14"
                               HorizontalOptions="Center"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                               HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <VerticalStackLayout Spacing="10">

                            <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð´Ð½Ñ -->
                            <Frame Padding="10"
                                   CornerRadius="8"
                                   BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}"
                                   BorderColor="{AppThemeBinding Light=#BBDEFB, Dark=#1976D2}"
                                   Margin="0,0,0,5">

                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="{Binding DateText}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}"
                                           VerticalOptions="Center"
                                           Grid.Column="0"/>

                                    <Label Text="{Binding DayTotalText}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{Binding DayTotalColor}"
                                           VerticalOptions="Center"
                                           Grid.Column="1"/>
                                </Grid>
                            </Frame>

                            <!-- Ð¡Ð´ÐµÐ»ÐºÐ¸ Ð·Ð° Ð´ÐµÐ½ÑŒ -->
                            <VerticalStackLayout Spacing="5">
                                <CollectionView ItemsSource="{Binding Operations}"
                                                SelectionMode="None"
                                                ItemsLayout="VerticalList">

                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame Padding="12"
                                                   Margin="0,0,0,5"
                                                   CornerRadius="8"
                                                   BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#2A2A2A}"
                                                   BorderColor="{AppThemeBinding Light=#E9ECEF, Dark=#3A3A3A}">

                                                <Grid ColumnDefinitions="Auto,*,Auto"
                                                      RowDefinitions="Auto,Auto"
                                                      ColumnSpacing="10"
                                                      RowSpacing="5">

                                                    <!-- Ð˜ÐºÐ¾Ð½ÐºÐ° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ -->
                                                    <Label Text="{Binding Icon}"
                                                           FontSize="20"
                                                           VerticalOptions="Center"
                                                           Grid.RowSpan="2"
                                                           Grid.Column="0"/>

                                                    <!-- Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð¸ Ñ‚Ð¸Ð¿ -->
                                                    <VerticalStackLayout Grid.Column="1">
                                                        <HorizontalStackLayout Spacing="5">
                                                            <Label Text="{Binding Ticker}"
                                                                   FontSize="14"
                                                                   FontAttributes="Bold"
                                                                   TextColor="{AppThemeBinding Light=Black, Dark=White}"/>
                                                            <Frame Padding="4,2"
                                                                   CornerRadius="4"
                                                                   BackgroundColor="{AppThemeBinding Light=#F3E5F5, Dark=#4A148C}">
                                                                <Label Text="{Binding InstrumentType}"
                                                                       FontSize="10"
                                                                       TextColor="{AppThemeBinding Light=#7B1FA2, Dark=#CE93D8}"/>
                                                            </Frame>
                                                        </HorizontalStackLayout>
                                                        <Label Text="{Binding Name}"
                                                               FontSize="12"
                               LineBreakMode="TailTruncation"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                                                    </VerticalStackLayout>

                                                    <!-- Ð¡ÑƒÐ¼Ð¼Ð° -->
                                                    <Label Text="{Binding AmountText}"
                                                           FontSize="16"
                                                           FontAttributes="Bold"
                                                           TextColor="{Binding AmountColor}"
                                                           HorizontalOptions="End"
                                                           VerticalOptions="Center"
                                                           Grid.Column="2"/>

                                                    <!-- Ð”ÐµÑ‚Ð°Ð»Ð¸ -->
                                                    <Grid Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2"
                                                          ColumnDefinitions="*,*,Auto"
                                                          ColumnSpacing="5">

                                                        <VerticalStackLayout Spacing="2" Grid.Column="0">
                                                            <Label Text="{Binding TimeText}"
                                                                   FontSize="12"
                                                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                                                            <Label Text="{Binding QuantityText}"
                                                                   FontSize="11"
                                                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                                                        </VerticalStackLayout>

                                                        <VerticalStackLayout Spacing="2" Grid.Column="1">
                                                            <Label Text="{Binding PriceText}"
                                                                   FontSize="12"
                                                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                                                            <Label Text="{Binding CommissionText}"
                                                                   FontSize="11"
                                                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                                                        </VerticalStackLayout>

                                                        <Button Text="ðŸ“‹"
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, 
                                                                         Path=BindingContext.ShowOperationDetailsCommand}"
                                                                CommandParameter="{Binding .}"
                                                                Padding="8"
                                                                CornerRadius="6"
                                                                BackgroundColor="Transparent"
                                                                TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                                                                BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                                                BorderWidth="1"
                                                                FontSize="12"
                                                                HeightRequest="30"
                                                                WidthRequest="30"
                                                                Grid.Column="2"/>
                                                    </Grid>

                                                </Grid>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>

                        </VerticalStackLayout>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ -->
        <Grid Grid.Row="4"
              ColumnDefinitions="*,*"
              ColumnSpacing="10"
              Margin="0,10,0,0">

            <Button Text="ðŸ”„ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"
                    Command="{Binding LoadOperationsCommand}"
                    IsEnabled="{Binding IsConnected}"
                    CornerRadius="10"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontSize="14"
                    Grid.Column="0"/>

            <Button Text="ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°"
                    Command="{Binding ShowStatisticsCommand}"
                    IsEnabled="{Binding HasOperations}"
                    CornerRadius="10"
                    BackgroundColor="{StaticResource Info}"
                    TextColor="White"
                    FontSize="14"
                    Grid.Column="1"/>
        </Grid>

        <!-- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ -->
        <Frame Grid.Row="1" Grid.RowSpan="4"
               Padding="15"
               CornerRadius="10"
               IsVisible="{Binding IsConnected, Converter={StaticResource InverseBooleanConverter}}"
               BackgroundColor="{StaticResource Warning}"
               BorderColor="#FFA000"
               VerticalOptions="Center"
               HorizontalOptions="Center"
               WidthRequest="300">

            <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                <Label Text="âš ï¸"
                       FontSize="24"
                       HorizontalOptions="Center"/>
                <Label Text="ÐÐµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ðº Tinkoff API"
                       FontSize="16"
                       FontAttributes="Bold"
                       TextColor="Black"
                       HorizontalOptions="Center"/>
                <Label Text="ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° Ð²ÐºÐ»Ð°Ð´ÐºÑƒ 4 Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ"
                       FontSize="12"
                       TextColor="Black"
                       HorizontalOptions="Center"/>

                <Button Text="ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ"
                        Command="{Binding ConnectToTinkoffCommand}"
                        CornerRadius="8"
                        BackgroundColor="#2196F3"
                        TextColor="White"
                        FontSize="14"
                        Padding="20,10"
                        HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Frame>

        <!-- Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ -->
        <ActivityIndicator Grid.Row="3"
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           Color="{StaticResource Primary}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Scale="1.5"/>

    </Grid>

</ContentPage>